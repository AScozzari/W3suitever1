â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ ISTRUZIONI INSTALLAZIONE AI VOICE AGENT - EDGVOIP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TRUNK: Messagenet Bologna Centrale
DID: 0510510510
edgvoip Trunk ID: b773a426-c646-47e4-ba13-1320dc8724cb

---

STEP 1: CARICARE SCRIPT LUA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

File da caricare: ai_http_streaming_realtime_FIXED.lua

Percorso destinazione:
/usr/share/freeswitch/scripts/ai_http_streaming_realtime_FIXED.lua

Comando SSH:
scp edgvoip_scripts/ai_http_streaming_realtime_FIXED.lua \
  root@pbx.edgvoip.it:/usr/share/freeswitch/scripts/

Permessi:
chmod 644 /usr/share/freeswitch/scripts/ai_http_streaming_realtime_FIXED.lua
chown freeswitch:freeswitch /usr/share/freeswitch/scripts/ai_http_streaming_realtime_FIXED.lua

---

STEP 2: CONFIGURARE DIALPLAN
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Aggiungere in: /etc/freeswitch/dialplan/default.xml

<extension name="ai-voice-agent-messagenet">
  <condition field="destination_number" expression="^(0510510510)$">
    <action application="set" data="bypass_media=false"/>
    <action application="answer"/>
    <action application="sleep" data="500"/>
    <action application="lua" data="ai_http_streaming_realtime_FIXED.lua"/>
  </condition>
</extension>

IMPORTANTE:
- bypass_media=false â†’ Necessario per registrare audio!
- answer â†’ Risponde alla chiamata prima dello script
- sleep 500 â†’ Stabilizza la connessione
- lua â†’ Esegue lo script

---

STEP 3: VERIFICARE PERMESSI /tmp/
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Lo script scrive file temporanei in /tmp/

Comando:
chmod 777 /tmp

Verifica:
ls -ld /tmp/
# Deve mostrare: drwxrwxrwx

---

STEP 4: RICARICARE DIALPLAN
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Comando FreeSWITCH CLI:
fs_cli -x "reloadxml"

Verifica:
fs_cli
> xml_locate dialplan
# Cerca "ai-voice-agent-messagenet"

---

STEP 5: TEST CHIAMATA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. Chiama: 0510510510

2. Controlla logs FreeSWITCH:
   fs_cli -x "console loglevel debug"
   # Cerca: [AI_REALTIME_FIXED]

3. Dovresti vedere:
   [AI_REALTIME_FIXED] ========== STARTING REALTIME SESSION (FIXED) ==========
   [AI_REALTIME_FIXED] âœ… Session created successfully
   [AI_REALTIME_FIXED] âœ… Chunk 1 sent (RAW PCM16)
   [AI_REALTIME_FIXED] ğŸ™ï¸ AI SPEAKING! Playing RAW PCM16 response...
   [AI_REALTIME_FIXED] âœ… AI audio played (RAW PCM16 @ 16kHz mono)

---

TROUBLESHOOTING COMUNE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âŒ Errore: "Permission denied" su /tmp/
âœ… Fix: chmod 777 /tmp

âŒ Errore: "curl: command not found"
âœ… Fix: apt-get install curl

âŒ Errore: "base64: command not found"
âœ… Fix: apt-get install coreutils

âŒ Errore: "cannot open /usr/share/freeswitch/scripts/ai_http_streaming_realtime_FIXED.lua"
âœ… Fix: Verifica percorso e permessi script

âŒ Nessun audio inviato al Voice Gateway
âœ… Fix: Verifica bypass_media=false nel dialplan

---

VERIFICHE POST-INSTALLAZIONE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. Script caricato:
   ls -la /usr/share/freeswitch/scripts/ai_http_streaming_realtime_FIXED.lua

2. Dialplan configurato:
   fs_cli -x "xml_locate dialplan" | grep ai-voice-agent

3. Permessi /tmp/ corretti:
   ls -ld /tmp/ | grep drwxrwxrwx

4. Voice Gateway raggiungibile:
   curl https://990d2e08-e877-47ab-86e4-4ab1ec4a5b18-00-a7zlal1jz3uk.worf.replit.dev/health

   Deve rispondere:
   {"status":"healthy","service":"w3-voice-gateway",...}

---

CONTATTI SUPPORTO
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Voice Gateway: https://990d2e08-e877-47ab-86e4-4ab1ec4a5b18-00-a7zlal1jz3uk.worf.replit.dev
API Key: openssl rand -hex 32
Tenant ID: 00000000-0000-0000-0000-000000000001

Endpoint diagnostica sessione:
curl -H "X-API-Key: openssl rand -hex 32" \
  https://990d2e08-e877-47ab-86e4-4ab1ec4a5b18-00-a7zlal1jz3uk.worf.replit.dev/api/voice/diagnostic/CALL_ID

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
